#!/usr/bin/env bash
set -Eeuo pipefail

# Auto re-add selected target files into chezmoi source state
# Triggered by LaunchAgent on file changes.

# Resolve chezmoi binary
CHEZMOI_BIN=""
for c in "$HOME/bin/chezmoi" \
         "/opt/homebrew/bin/chezmoi" \
         "/usr/local/bin/chezmoi" \
         "$(command -v chezmoi 2>/dev/null || true)"; do
  if [[ -n "$c" && -x "$c" ]]; then CHEZMOI_BIN="$c"; break; fi
done
if [[ -z "$CHEZMOI_BIN" ]]; then
  echo "[auto-readd] chezmoi not found" >&2
  exit 0
fi

REPO="$HOME/.local/share/chezmoi"

# Files to watch and re-add when changed
FILES=(
  "$HOME/.zprofile"
  "$HOME/.zshrc"
)

# Re-add each file if it exists (idempotent)
changed=0
for f in "${FILES[@]}"; do
  [[ -e "$f" ]] || continue
  if "$CHEZMOI_BIN" re-add --no-tty "$f"; then
    changed=1
  fi
done

# Commit if there are staged changes
if [[ $changed -eq 1 ]]; then
  if git -C "$REPO" diff --name-only --exit-code >/dev/null; then
    : # no working tree changes
  fi
  if ! git -C "$REPO" diff --cached --quiet; then
    msg="auto: re-add changed dotfiles ($(date +%Y-%m-%dT%H:%M:%S%z))"
    git -C "$REPO" commit -m "$msg" || true
    if [[ "${CHEZMOI_AUTO_PUSH:-0}" == "1" ]]; then
      git -C "$REPO" push origin master || true
    fi
  fi
fi

exit 0


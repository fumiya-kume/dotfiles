#!/usr/bin/env pwsh
Set-StrictMode -Version Latest
$ErrorActionPreference = 'Stop'

# Installs Bun on Windows using the official PowerShell installer.

function BunPresent {
  try {
    $cmd = Get-Command bun -ErrorAction Stop
    if ($cmd) { return $true }
  } catch {}
  $bunExe = Join-Path $env:USERPROFILE ".bun\bin\bun.exe"
  return (Test-Path $bunExe)
}

if (BunPresent) {
  try {
    $version = (bun --version)
  } catch {
    $version = "installed"
  }
  Write-Output "[chezmoi] Bun already present. Version: $version"
  exit 0
}

Write-Output "[chezmoi] Installing Bun via official PowerShell installer..."
$ProgressPreference = 'SilentlyContinue'
try {
  # Per Bun's Windows install instructions
  iex "& { $(irm bun.sh/install.ps1) }"
} catch {
  Write-Error "[chezmoi] Bun installation failed: $_"
  exit 1
}

# Ensure Bun is on PATH for the remainder of this session
$bunBin = Join-Path $env:USERPROFILE ".bun\bin"
if (Test-Path (Join-Path $bunBin "bun.exe")) {
  $env:PATH = "$bunBin;$env:PATH"
}

try {
  $version = (bun --version)
} catch {
  $version = "installed"
}
Write-Output "[chezmoi] Bun installed. Version: $version"


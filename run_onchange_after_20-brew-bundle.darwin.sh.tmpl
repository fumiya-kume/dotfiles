#!/usr/bin/env bash
set -Eeuo pipefail

# Trigger re-run when Brewfile content changes (chezmoi template)
# Uses supported function `sha256sum` instead of unsupported `sha256`.
# If your repo uses a different filename, adjust include target.
# trigger: {{ include "dot_Brewfile" | sha256sum }}

# Ensure brew available in this script session
if ! command -v brew >/dev/null 2>&1; then
  if [[ -x "/opt/homebrew/bin/brew" ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  elif [[ -x "/usr/local/bin/brew" ]]; then
    eval "$(/usr/local/bin/brew shellenv)"
  fi
fi

if ! command -v brew >/dev/null 2>&1; then
  echo "[chezmoi] brew not found. Skipping Brew Bundle."
  exit 0
fi

echo "[chezmoi] Skipping deprecated homebrew/bundle tap (now built-in)."

# Prefer global Brewfile (~/.Brewfile) if present, otherwise support repo-root Brewfile.
BREWFILE_GLOBAL="${HOME}/.Brewfile"
BREWFILE_REPO="{{ .chezmoi.sourceDir }}/Brewfile"

if [[ -f "${BREWFILE_GLOBAL}" ]]; then
  echo "[chezmoi] Running: brew bundle --global"
  HOMEBREW_NO_AUTO_UPDATE=1 brew bundle --global
elif [[ -f "${BREWFILE_REPO}" ]]; then
  echo "[chezmoi] Running: brew bundle --file=${BREWFILE_REPO}"
  HOMEBREW_NO_AUTO_UPDATE=1 brew bundle --file="${BREWFILE_REPO}"
else
  echo "[chezmoi] No Brewfile found (expected ${BREWFILE_GLOBAL} or ${BREWFILE_REPO}). Skipping."
fi
